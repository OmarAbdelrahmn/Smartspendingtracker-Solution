@using SpendingTracker.Helpers
@{
    ViewData["Title"] = "التقارير";
    var settings = ViewBag.Settings as Smartspendingtracker.Models.UserSettings;
}

<h4 class="mb-3">تقارير المصروفات</h4>

<!-- Filters -->
<div class="card border-0 shadow-sm mb-3">
    <div class="card-body p-3">
        <form method="get">
            <div class="mb-2">
                <label class="form-label small text-muted mb-1">من تاريخ</label>
                <input type="date" name="startDate" class="form-control" value="@ViewBag.StartDate.ToString("yyyy-MM-dd")" />
            </div>

            <div class="mb-2">
                <label class="form-label small text-muted mb-1">إلى تاريخ</label>
                <input type="date" name="endDate" class="form-control" value="@ViewBag.EndDate.ToString("yyyy-MM-dd")" />
            </div>

            <button type="submit" class="btn btn-primary w-100 mt-2">
                <i class="fas fa-search ms-1"></i>
                عرض التقرير
            </button>
        </form>
    </div>
</div>

<!-- Summary Card -->
<div class="card bg-gradient-primary text-white border-0 shadow-sm mb-3">
    <div class="card-body p-3">
        <div class="w-100">
            <div class="small opacity-75 mb-1">إجمالي المصروفات</div>
            <h3 class="mb-2">
                @CurrencyHelper.FormatAmount(ViewBag.TotalSpent, settings)
            </h3>
            <div class="small opacity-75 mb-2">
                <i class="fas fa-calculator ms-1"></i>
                المتوسط اليومي: @CurrencyHelper.FormatAmount(ViewBag.AveragePerDay, settings)
            </div>
            <div class="small opacity-75">
                <i class="fas fa-calendar-alt ms-1"></i>
                @ViewBag.StartDate.ToString("dd-MM-yyyy", new System.Globalization.CultureInfo("en-US"))
                -
                @ViewBag.EndDate.ToString("dd-MM-yyyy", new System.Globalization.CultureInfo("en-US"))
            </div>
        </div>
    </div>
</div>

<!-- Chart -->
<div class="card border-0 shadow-sm mb-3">
    <div class="card-header bg-transparent border-0 p-3">
        <h6 class="mb-0">
            <i class="fas fa-chart-line ms-1"></i>
            اتجاه المصروف اليومي
        </h6>
    </div>
    <div class="card-body p-2">
        <div style="position: relative; height: 200px;">
            <canvas id="dailyChart"></canvas>
        </div>
    </div>
</div>

<!-- Top Locations -->
<div class="card border-0 shadow-sm mb-3">
    <div class="card-header bg-transparent border-0 p-3">
        <h6 class="mb-0">
            <i class="fas fa-map-marker-alt ms-1"></i>
            أعلى أماكن الصرف
        </h6>
    </div>
    <div class="card-body p-2">
        @if (ViewBag.TopLocations.Count == 0)
        {
            <div class="text-center text-muted py-3">
                <i class="fas fa-inbox fa-2x mb-2"></i>
                <p class="mb-0">لا توجد بيانات</p>
            </div>
        }
        else
        {
            @foreach (var location in ViewBag.TopLocations)
            {
                <div class="d-flex justify-content-between align-items-center p-2 border-bottom">
                    <div>
                        <h6 class="mb-0">@location.Location</h6>
                        <small class="text-muted">@location.Count عملية</small>
                    </div>
                    <h6 class="mb-0 text-danger">@CurrencyHelper.FormatAmount(location.Amount, settings)</h6>
                </div>
            }
        }
    </div>
</div>

<!-- Transactions List -->
<div class="card border-0 shadow-sm mb-3">
    <div class="card-header bg-transparent border-0 p-3 d-flex justify-content-between align-items-center">
        <h6 class="mb-0">جميع العمليات</h6>
        <button class="btn btn-sm btn-outline-primary" onclick="window.print()">
            <i class="fas fa-print ms-1"></i>
            طباعة
        </button>
    </div>
    <div class="card-body p-0">
        @if (ViewBag.Transactions.Count == 0)
        {
            <div class="text-center text-muted py-4">
                لا توجد عمليات في هذه الفترة
            </div>
        }
        else
        {
            @foreach (var t in ViewBag.Transactions)
            {
                <div class="d-flex justify-content-between align-items-center p-3 border-bottom">
                    <div>
                        <h6 class="mb-0">@t.Description</h6>
                        <small class="text-muted">@t.Date.ToString("dd-MM-yyyy")</small>
                    </div>
                    <h6 class="mb-0 text-danger">@CurrencyHelper.FormatAmount(t.Amount, settings)</h6>
                </div>
            }
        }
    </div>
</div>

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script>
        Chart.defaults.color = '#999';
        Chart.defaults.borderColor = '#333';

        const dailyChart = new Chart(document.getElementById('dailyChart'), {
            type: 'line',
            data: {
                labels: [@foreach (var day in ViewBag.DailySummary) {
                @Html.Raw($"'{day.Date.ToString("dd/MM")}',")
            }
],
            datasets: [{
                label: 'المصروفات',
                data: [@foreach (var day in ViewBag.DailySummary) {
                @Html.Raw($"{day.Amount},")
                                }
],
                borderColor: '#667eea',
                backgroundColor: 'rgba(102, 126, 234, 0.1)',
                borderWidth: 2,
                tension: 0.4,
                fill: true
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { display: false }
            },
            scales: {
                y: { beginAtZero: true }
            }
        }
    });
</script>
}

<style>
    .bg-gradient-primary {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    }

    @@media print {
        .btn, .card-header button {
            display: none !important;
        }
    }
</style>